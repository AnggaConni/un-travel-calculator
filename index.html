<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UN Travel & DSA Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .scroller::-webkit-scrollbar { width: 8px; height: 8px; }
        .scroller::-webkit-scrollbar-track { background: #f1f5f9; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .scroller::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .excel-header { display: grid; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-size: 11px; font-weight: 600; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; }
        .excel-cell { padding: 8px 12px; border-right: 1px solid #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .excel-cell:last-child { border-right: none; }
        .slide-content { transition: opacity 0.5s ease-in-out; }
        .hidden-slide { display: none; opacity: 0; }
        .active-slide { display: block; opacity: 1; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .progress-bar { height: 3px; background: #cbd5e1; width: 100%; position: absolute; bottom: 0; left: 0; }
        .progress-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 3s linear; }
        .paused .progress-fill { transition: none; background: #f59e0b; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); z-index: 50; }
        .modal-container { position: fixed; inset: 0; z-index: 51; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        /* Toast Notification */
        #toast { visibility: hidden; opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 20px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-24 relative font-sans">

    <!-- Navbar -->
    <nav class="bg-blue-900 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="ph ph-airplane-tilt text-2xl text-blue-300"></i>
                    <span class="font-bold text-xl tracking-tight">UN Travel Calculator <span class="text-blue-300 text-sm font-normal">Audit Edition v9.0</span></span>
                </div>
                <div class="text-xs text-blue-200 hidden md:block text-right">
                    Auto-Calculation Engine v9.0 (Deploy Ready)
                    <div class="font-semibold text-blue-100 mt-0.5">Angga Conni Saputra</div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        <!-- Header Controls -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 md:col-span-2 flex flex-col gap-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <div class="flex justify-between items-center mb-1.5">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wide">Target Currency & UNORE</label>
                            <button onclick="toggleMixedHelp()" class="text-[9px] text-indigo-600 hover:text-indigo-800 font-bold bg-indigo-50 px-2 py-0.5 rounded cursor-pointer border border-indigo-200 flex items-center gap-1 transition-colors"><i class="ph ph-book-open"></i> Admin Guide</button>
                        </div>
                        <div class="flex gap-2 h-9">
                            <select id="currencyCode" onchange="updateBaseCurrencyLabel()" class="w-1/3 px-2 border border-slate-300 rounded-lg text-xs font-bold text-slate-700 bg-slate-50 cursor-pointer focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <optgroup label="Default"><option value="IDR" selected>IDR ðŸ‡®ðŸ‡©</option></optgroup>
                                <optgroup label="Major"><option value="USD">USD ðŸ‡ºðŸ‡¸</option><option value="EUR">EUR ðŸ‡ªðŸ‡º</option></optgroup>
                                <optgroup label="Regional"><option value="MYR">MYR ðŸ‡²ðŸ‡¾</option><option value="THB">THB ðŸ‡¹ðŸ‡­</option><option value="PHP">PHP ðŸ‡µðŸ‡­</option></optgroup>
                            </select>
                            <input type="number" id="unoreRate" value="15400" class="w-2/3 px-3 border border-slate-300 rounded-lg font-mono text-right font-bold text-blue-900 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Rate">
                        </div>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-purple-600 mb-1.5 uppercase tracking-wide">Incidental %</label>
                        <div class="relative h-9">
                            <input type="number" id="incidentalRate" value="20" class="w-full h-full px-2 border border-purple-200 bg-purple-50 text-purple-700 rounded-lg font-mono text-center font-bold text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none">
                            <span class="absolute right-3 top-2 text-purple-400 text-xs font-semibold">%</span>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 p-2 rounded-lg border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Meal Deduction Logic</label>
                        <div class="flex bg-white border border-slate-300 rounded p-0.5 shadow-sm">
                            <button id="btnStandard" onclick="setMealMode('standard', false)" class="px-3 py-1 text-[10px] font-bold rounded bg-blue-100 text-blue-700 transition-all">Standard (Day)</button>
                            <button id="btnGranular" onclick="setMealMode('granular', false)" class="px-3 py-1 text-[10px] font-bold rounded text-slate-500 hover:text-slate-700 transition-all">Granular (B/L/D)</button>
                        </div>
                    </div>
                    <div id="standardMealInput" class="block">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-500 w-24 font-medium">Total Deduction:</span>
                            <div class="relative w-24 h-8">
                                <input type="number" id="mealDedRateStandard" value="30" class="w-full h-full px-2 border border-slate-300 rounded text-center text-xs font-bold text-slate-700 focus:outline-none focus:border-blue-500">
                                <span class="absolute right-2 top-2 text-slate-400 text-[9px]">%</span>
                            </div>
                        </div>
                    </div>
                    <div id="granularMealInputs" class="hidden">
                        <div class="grid grid-cols-3 gap-3">
                            <div class="relative h-9 border border-orange-200 bg-white rounded flex items-center px-1"><span class="text-[9px] font-bold text-orange-600 bg-orange-50 px-1 rounded mr-1">Bkfast</span><input type="number" id="bfDedRate" value="6" class="w-full h-full text-center text-xs font-bold text-slate-700 outline-none"><span class="text-[9px] text-slate-400">%</span></div>
                            <div class="relative h-9 border border-orange-200 bg-white rounded flex items-center px-1"><span class="text-[9px] font-bold text-orange-600 bg-orange-50 px-1 rounded mr-1">Lunch</span><input type="number" id="lunchDedRate" value="12" class="w-full h-full text-center text-xs font-bold text-slate-700 outline-none"><span class="text-[9px] text-slate-400">%</span></div>
                            <div class="relative h-9 border border-orange-200 bg-white rounded flex items-center px-1"><span class="text-[9px] font-bold text-orange-600 bg-orange-50 px-1 rounded mr-1">Dinner</span><input type="number" id="dinnerDedRate" value="12" class="w-full h-full text-center text-xs font-bold text-slate-700 outline-none"><span class="text-[9px] text-slate-400">%</span></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-12 gap-3 pt-1">
                    <div class="col-span-5"><label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Mission Name</label><input type="text" id="missionName" class="w-full h-9 px-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm text-slate-700 placeholder-slate-400" placeholder="e.g. Annual Review"></div>
                    <div class="col-span-3"><label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Date</label><input type="date" id="reportDate" class="w-full h-9 px-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-xs text-slate-700"></div>
                    <div class="col-span-4"><label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase flex items-center gap-1">Email <button onclick="toggleEmailHelp()" class="text-blue-400 hover:text-blue-600"><i class="ph ph-info-fill"></i></button></label><input type="email" id="recipientEmail" class="w-full h-9 px-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm text-slate-700 placeholder-slate-400" placeholder="finance@un.org"></div>
                </div>
            </div>

            <div id="slider-container" class="bg-gradient-to-br from-blue-50 to-white p-6 rounded-xl border border-blue-100 md:col-span-2 flex flex-col justify-between relative overflow-hidden h-full group shadow-sm">
                <div class="min-h-[180px] flex flex-col justify-center">
                    <div class="slide-content active-slide" id="slide-0"><h3 class="text-blue-900 font-bold text-lg mb-2 flex items-center gap-2"><i class="ph ph-arrows-left-right text-blue-600"></i> Hybrid Meal Logic</h3><ul class="text-sm text-blue-800 space-y-1 list-disc list-inside"><li><strong>Standard Mode:</strong> Use "Meal Days" (Col 5) to deduct full daily meals (30%). Simple.</li><li><strong>Granular Mode:</strong> Use columns 5, 6, 7 to deduct specific meals (Breakfast, Lunch, Dinner). Precise.</li></ul></div>
                    <div class="slide-content hidden-slide" id="slide-1"><h3 class="text-blue-900 font-bold text-lg mb-2 flex items-center gap-2"><i class="ph ph-shield-check text-orange-600"></i> Floor Rule Policy</h3><ul class="text-sm text-blue-800 space-y-1 list-disc list-inside"><li><strong>Incidentals (15-20%)</strong> are the staff's minimum entitlement.</li><li>System guarantees staff receive at least the Incidental portion even if deductions are high.</li></ul></div>
                    <div class="slide-content hidden-slide" id="slide-2"><h3 class="text-blue-900 font-bold text-lg mb-2 flex items-center gap-2"><i class="ph ph-currency-circle-dollar text-green-600"></i> Hybrid Currency</h3><ul class="text-sm text-blue-800 space-y-1 list-disc list-inside"><li><strong>Local Base (IDR):</strong> For local staff. Reference data in IDR.</li><li><strong>USD Base ($):</strong> For international experts. Reference data in USD.</li></ul></div>
                    <div class="slide-content hidden-slide" id="slide-3"><h3 class="text-blue-900 font-bold text-lg mb-2 flex items-center gap-2"><i class="ph ph-globe text-slate-600"></i> Official Data Source</h3><p class="text-sm text-blue-800 mb-4">Always verify latest DSA & Room Rates via the official ICSC website.</p><a href="https://icsc.un.org/" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm border border-blue-200">Open ICSC Website <i class="ph ph-arrow-square-out"></i></a></div>
                </div>
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-blue-100 z-10"><div class="flex gap-1" id="dots-container"></div><div class="flex gap-2"><button onclick="prevSlide()" class="p-1 rounded hover:bg-blue-100 text-blue-600"><i class="ph ph-caret-left text-xl"></i></button><button onclick="nextSlide()" class="p-1 rounded hover:bg-blue-100 text-blue-600"><i class="ph ph-caret-right text-xl"></i></button></div></div>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            </div>
        </section>

        <!-- Main Input Area -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[450px]">
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex flex-col gap-3">
                    <div class="flex justify-between items-center w-full">
                        <div class="flex items-center gap-2"><h3 class="font-bold text-slate-700 text-sm"><i class="ph ph-database text-blue-600"></i> Reference Data</h3><button onclick="toggleCurrencyHelp()" class="bg-white text-blue-600 hover:text-blue-800 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-200 shadow-sm transition">Help</button></div>
                        <button onclick="loadSampleRef()" class="text-[10px] bg-white border border-slate-300 px-3 py-1 rounded hover:bg-slate-50 text-slate-600 shadow-sm transition">Load Sample</button>
                    </div>
                    <div class="flex items-center justify-between bg-white p-2 rounded border border-slate-200 shadow-sm"><div class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">DSA Base Currency:</div><select id="baseCurrency" onchange="updateRefHeaders()" class="text-xs border border-slate-300 rounded px-2 py-1 bg-slate-50 font-bold text-blue-700 outline-none cursor-pointer focus:ring-1 focus:ring-blue-500"><option value="TARGET" selected>Same as Target (IDR)</option><option value="USD">USD ($)</option></select></div>
                    <p class="text-[10px] text-slate-400 italic">Copy from Excel (no header) & Paste below</p>
                </div>
                <div class="excel-header" style="grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr;"><div class="excel-cell">City</div><div class="excel-cell text-center" id="dsaRefHeader">DSA (IDR)</div><div class="excel-cell text-center">Room (%)</div><div class="excel-cell text-center">TF ($)</div></div>
                <div class="relative flex-1 group"><textarea id="refInput" class="w-full h-full p-4 font-mono text-xs focus:outline-none resize-none bg-slate-50/20 group-hover:bg-white transition-colors" placeholder="Copy the format without header:&#10;Jakarta	4500000	55	47&#10;Bali	3200000	45	47"></textarea></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[450px]">
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex flex-col gap-3 justify-between h-[126px]">
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col">
                             <div class="flex items-center gap-2 mb-1"><h3 class="font-bold text-slate-700 text-sm"><i class="ph ph-users text-green-600"></i> Participant Data</h3><button onclick="toggleFormatHelp()" class="bg-white text-blue-600 hover:text-blue-800 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-200 shadow-sm transition">Help</button></div>
                            <p class="text-[10px] text-slate-500 font-medium" id="inputInstruction">Mode: Standard (6 Cols)</p>
                        </div>
                        <button onclick="loadSampleParticipants()" class="text-[10px] bg-white border border-slate-300 px-3 py-1 rounded hover:bg-slate-50 text-slate-600 shadow-sm transition">Load Auto-Dummy (10)</button>
                    </div>
                     <p class="text-[10px] text-slate-400 italic">Paste from Excel (See Help for columns)</p>
                </div>
                <div id="excelHeaderStandard" class="excel-header" style="grid-template-columns: 1.5fr 1fr 0.6fr 0.8fr 0.8fr 0.6fr;"><div class="excel-cell">Name</div><div class="excel-cell">City</div><div class="excel-cell text-center">Days</div><div class="excel-cell text-center text-[10px] text-blue-700 bg-blue-50">Htl Ded</div><div class="excel-cell text-center text-[10px] text-orange-700 bg-orange-50">Meal Days</div><div class="excel-cell text-center">Legs</div></div>
                <div id="excelHeaderGranular" class="excel-header hidden" style="grid-template-columns: 1.5fr 1fr 0.6fr 0.6fr 0.5fr 0.5fr 0.5fr 0.6fr;"><div class="excel-cell">Name</div><div class="excel-cell">City</div><div class="excel-cell text-center">Days</div><div class="excel-cell text-center text-[10px] text-blue-700 bg-blue-50">Htl</div><div class="excel-cell text-center text-[10px] bg-orange-50">B</div><div class="excel-cell text-center text-[10px] bg-orange-50">L</div><div class="excel-cell text-center text-[10px] bg-orange-50">D</div><div class="excel-cell text-center">Legs</div></div>
                <div class="relative flex-1 group"><textarea id="partInput" class="w-full h-full p-4 font-mono text-xs focus:outline-none resize-none bg-slate-50/20 group-hover:bg-white transition-colors" placeholder=""></textarea></div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="flex flex-col sm:flex-row justify-center gap-4">
            <button onclick="processData(true)" class="group bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center gap-3 transform hover:-translate-y-1 active:scale-95"><i class="ph ph-shield-check text-2xl group-hover:scale-110 transition-transform"></i> Calculate with Floor Rule <span class="text-[10px] bg-blue-500 text-white px-2 py-0.5 rounded ml-1 font-bold">Recommended</span></button>
            <button onclick="processData(false)" class="group bg-slate-200 hover:bg-slate-300 text-slate-700 text-lg font-semibold py-3 px-8 rounded-xl shadow hover:shadow-md transition-all flex items-center gap-3 transform hover:-translate-y-1 active:scale-95 border border-slate-300"><i class="ph ph-calculator text-2xl group-hover:rotate-12 transition-transform text-slate-500"></i> Calculate without Floor Rule <span class="text-[10px] bg-slate-300 text-slate-600 px-2 py-0.5 rounded ml-1 font-bold">Raw</span></button>
        </div>

        <!-- RESULTS SECTION -->
        <section id="resultSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50">
                    <div>
                        <div class="flex items-center gap-3">
                            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-receipt text-blue-600"></i> Calculation Report</h2>
                            <span id="modeBadge" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500 border border-gray-200 font-bold shadow-sm">Mode: Unknown</span>
                            <button onclick="toggleCsvHelp()" class="text-xs flex items-center gap-1.5 text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-full border border-blue-200 transition font-bold shadow-sm"><i class="ph ph-warning-circle text-lg"></i> Excel Warning?</button>
                        </div>
                        <p class="text-sm text-slate-500 mt-1 ml-8">DSA Breakdown & Terminal Fare Estimation</p>
                    </div>
                    <div class="flex gap-3 items-center">
                         <div class="text-right mr-4"><div class="text-xs text-slate-400 font-bold uppercase tracking-wider">Total Payout (Est.)</div><div class="font-bold text-2xl text-emerald-600" id="grandTotalDisplay">0</div></div>
                        <div class="flex gap-2">
                            <button onclick="toggleEmailHelp()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition shadow-md" title="Email Summary"><i class="ph ph-paper-plane-tilt text-lg"></i></button>
                            <button onclick="exportToExcelWithFormulas()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition shadow-md"><i class="ph ph-file-xls text-lg"></i> Export Excel (Audit Ready)</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto scroller">
                    <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead class="bg-white text-slate-500 font-medium border-b border-slate-200 text-xs uppercase tracking-wide">
                            <tr>
                                <th class="px-4 py-3 bg-slate-50">Name</th><th class="px-4 py-3 bg-slate-50">City</th><th class="px-4 py-3 text-center bg-slate-50">Days</th><th class="px-4 py-3 text-center bg-slate-50" id="baseDsaHeader">Base DSA</th><th class="px-4 py-3 text-center text-purple-600 bg-purple-50 border-l border-r border-purple-100">Incidental</th>
                                <th class="px-4 py-3 text-center bg-blue-50 text-blue-800 border-l border-blue-100">Hotel (Ded)</th><th class="px-4 py-3 text-center bg-orange-50 text-orange-800 border-r border-orange-100">Meals (Ded)</th>
                                <th class="px-4 py-3 text-right bg-slate-50">Deductions</th><th class="px-4 py-3 text-right font-bold text-blue-700 bg-blue-50/30">Net Payable</th><th class="px-4 py-3 text-right bg-slate-50">TF ($)</th>
                                <th class="px-4 py-3 text-right bg-gray-50 text-slate-500 border-r border-slate-200">Total USD (Ref)</th>
                                <th class="pl-6 pr-8 py-3 text-right font-bold text-emerald-700 bg-emerald-50/30" id="headerTotalLocal">Total (Final)</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
    
    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-[60]">
        <i class="ph ph-check-circle text-green-400 text-xl"></i>
        <div>
            <h4 class="font-bold text-sm">Calculation Complete</h4>
            <p class="text-xs text-slate-300" id="toastMessage">Showing results for Standard Mode</p>
        </div>
    </div>

    <!-- MODALS -->
    <!-- 1. EXCEL GUIDE -->
    <div id="csvHelpModal" class="hidden modal-overlay"><div class="modal-container"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
        <h3 class="font-bold text-lg mb-2 text-emerald-700 flex items-center gap-2"><i class="ph ph-shield-check"></i> Don't Panic! Excel Safety Guide</h3>
        <p class="text-sm text-gray-600 mb-4">This file is generated using a special method to keep <strong>Formulas Active</strong> without needing a server. Excel doesn't recognize this method, so it shows a standard warning.</p>
        <p class="text-sm text-gray-800 mb-4 font-bold">Rest assured, the file is 100% Safe.</p>
        <div class="bg-yellow-50 p-3 rounded mb-3 border border-yellow-200"><h4 class="text-sm font-bold text-yellow-800">1. "Format differs..." Warning</h4><p class="text-xs text-slate-600">This is normal for HTML-based Excel files.</p><p class="text-xs font-semibold text-slate-800 mt-1">âœ… Action: Click <strong>"YES"</strong> to open.</p></div>
        <div class="bg-blue-50 p-3 rounded border border-blue-200"><h4 class="text-sm font-bold text-blue-800">2. "Protected View"</h4><p class="text-xs text-slate-600">If the screen is blank/grey.</p><p class="text-xs font-semibold text-slate-800 mt-1">âœ… Action: Click <strong>"Enable Editing"</strong> button at the top.</p></div>
        <div class="mt-4 flex justify-end"><button onclick="toggleCsvHelp()" class="bg-emerald-600 text-white px-4 py-2 rounded">I Understand, It's Safe</button></div>
    </div></div></div>

    <!-- 2. FORMAT GUIDE -->
    <div id="formatHelpModal" class="hidden modal-overlay"><div class="modal-container"><div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6">
        <h3 class="font-bold text-lg mb-4 text-slate-800 border-b border-slate-200 pb-2"><i class="ph ph-table text-blue-600"></i> Excel Data Format Guide</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h4 class="font-bold text-blue-700 text-sm mb-2 uppercase">Option A: Standard Mode (Simple)</h4>
                <div class="flex text-[10px] font-mono border border-slate-300 rounded mb-2 overflow-hidden bg-white"><div class="p-1 border-r w-1/6">1.Name</div><div class="p-1 border-r w-1/6">2.City</div><div class="p-1 border-r w-1/6">3.Days</div><div class="p-1 border-r w-1/6 bg-blue-50 font-bold">4.Hotel</div><div class="p-1 border-r w-1/6 bg-orange-50 font-bold">5.Meals</div><div class="p-1 w-1/6">6.Legs</div></div>
                <div class="bg-blue-100 p-2 rounded mb-2"><span class="text-[9px] font-bold text-red-600 float-right">DEDUCTION</span><strong class="text-xs text-blue-900">Column 4: Hotel Days</strong><ul class="list-disc list-inside text-xs text-slate-700 space-y-1 mt-1"><li>Type <strong>Number</strong> (e.g., 3) = Organizer PAID for 3 days. <span class="text-red-600">(-3 Days Cut)</span></li><li>Type <strong>'Y'</strong> = Organizer PAID EVERYTHING. <span class="text-red-600">(Full Cut)</span></li><li>Type <strong>'0'</strong> = Staff paid themselves. <span class="text-green-700 font-bold">(No Cut / Full DSA)</span></li></ul></div>
                <div class="bg-orange-100 p-2 rounded"><span class="text-[9px] font-bold text-red-600 float-right">DEDUCTION</span><strong class="text-xs text-orange-900">Column 5: Meal Days</strong><ul class="list-disc list-inside text-xs text-slate-700 space-y-1 mt-1"><li>Type <strong>Number</strong> (e.g., 2) = Organizer provided FREE meals for 2 days.</li><li>Type <strong>'Y'</strong> = Full Board provided.</li><li>Type <strong>'0'</strong> = Staff bought their own meals. <span class="text-green-700 font-bold">(Full DSA)</span></li></ul></div>
            </div>
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h4 class="font-bold text-orange-700 text-sm mb-2 uppercase">Option B: Granular Mode (Precise)</h4>
                <div class="flex text-[10px] font-mono border border-slate-300 rounded mb-2 overflow-hidden bg-white"><div class="p-1 border-r w-1/8">1.Name</div><div class="p-1 border-r w-1/8">2.City</div><div class="p-1 border-r w-1/12">3.Day</div><div class="p-1 border-r w-1/8 bg-blue-50 font-bold">4.Htl</div><div class="p-1 border-r w-1/12 bg-orange-50 font-bold">5.B</div><div class="p-1 border-r w-1/12 bg-orange-50 font-bold">6.L</div><div class="p-1 border-r w-1/12 bg-orange-50 font-bold">7.D</div><div class="p-1 w-1/12">8.Leg</div></div>
                <div class="bg-orange-100 p-2 rounded"><span class="text-[9px] font-bold text-red-600 float-right">DEDUCTION</span><strong class="text-xs text-orange-900">Columns 5, 6, 7: Meals</strong><ul class="list-disc list-inside text-xs text-slate-700 space-y-1 mt-1"><li><strong>Col 5 (B):</strong> Days Free Breakfast.</li><li><strong>Col 6 (L):</strong> Days Free Lunch.</li><li><strong>Col 7 (D):</strong> Days Free Dinner.</li><li>Type <strong>'0'</strong> = Staff bought their own meals. <span class="text-green-700 font-bold">(Full DSA)</span></li></ul></div>
            </div>
        </div>
        <div class="mt-4 flex justify-end"><button onclick="toggleFormatHelp()" class="bg-slate-800 text-white px-6 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-900 transition">Close Guide</button></div>
    </div></div></div>

    <!-- 3. CURRENCY HELP -->
    <div id="currencyHelpModal" class="hidden modal-overlay"><div class="modal-container"><div class="bg-white rounded-lg p-6 max-w-lg">
        <h3 class="font-bold text-lg mb-4 text-blue-900 flex items-center gap-2"><i class="ph ph-currency-circle-dollar"></i> Currency Logic Guide</h3>
        <p class="text-sm text-slate-600 mb-4">This setting determines how the calculator interprets the "DSA Rate" column in your Reference Data.</p>
        <div class="space-y-3">
             <div class="bg-slate-50 p-3 rounded-lg border border-slate-200"><h4 class="text-sm font-bold text-slate-800 mb-1 flex items-center gap-2"><span class="bg-slate-200 px-2 rounded text-xs">Option A</span> Same as Target (e.g. IDR)</h4><div class="text-xs text-slate-600 pl-2 border-l-2 border-slate-300 ml-1"><p><strong>Use for:</strong> Local Staff / National Officers.</p><p class="mt-1"><strong>Logic:</strong> You enter DSA in Rupiah (e.g. 4,500,000). The system adds Terminal Fare (converted from USD) to this amount.</p></div></div>
             <div class="bg-blue-50 p-3 rounded-lg border border-blue-200"><h4 class="text-sm font-bold text-blue-800 mb-1 flex items-center gap-2"><span class="bg-blue-200 px-2 rounded text-xs text-blue-900">Option B</span> USD ($)</h4><div class="text-xs text-slate-600 pl-2 border-l-2 border-blue-300 ml-1"><p><strong>Use for:</strong> International Staff / Experts.</p><p class="mt-1"><strong>Logic:</strong> You enter DSA in USD (e.g. $400). The system calculates everything in USD first, then converts the Final Total to Target Currency using UNORE.</p></div></div>
        </div>
        <p class="text-xs text-slate-500 italic mt-3">* Tip: Terminal Fare (TF) is ALWAYS treated as USD input and converted automatically.</p>
        <div class="mt-4 flex justify-end"><button onclick="toggleCurrencyHelp()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded">Got it</button></div>
    </div></div></div>

    <!-- OTHER MODALS -->
    <div id="emailHelpModal" class="hidden modal-overlay"><div class="modal-container"><div class="bg-white rounded-lg p-6 max-w-lg"><h3 class="font-bold">Email Guide</h3><p class="text-sm mt-2">Launches default mail app.</p><button onclick="executeMailTo()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded">Launch</button><button onclick="toggleEmailHelp()" class="mt-4 ml-2 text-slate-500">Close</button></div></div></div>
    <div id="mixedHelpModal" class="hidden modal-overlay"><div class="modal-container"><div class="bg-white rounded-lg p-6 max-w-lg"><h3 class="font-bold text-indigo-700">Admin Guide: Currency</h3><p class="text-sm mt-3 text-slate-600">Do you have participants paid in <strong>IDR (Locals)</strong> and <strong>USD (Internationals)</strong> in the same event?</p><div class="bg-slate-50 border border-slate-200 p-3 rounded mt-3"><h4 class="text-xs font-bold text-slate-800">ðŸ’¡ Best Practice Strategy</h4><p class="text-xs text-slate-600 mb-2">Finance rules usually require separate payment batches. Please <strong>do not mix them</strong> in one calculation.</p><ul class="list-disc list-inside text-xs text-slate-600 mt-1"><li><strong>Run Batch 1 (Locals):</strong> Select "Same as Target (IDR)". Input local staff. Export.</li><li><strong>Run Batch 2 (Internationals):</strong> Change Base to "USD". Input intl staff. Export.</li></ul></div><p class="text-xs text-slate-400 mt-3 italic">* Mixing currencies in one table makes the "Grand Total" mathematically invalid and may be rejected by Audit.</p><button onclick="toggleMixedHelp()" class="mt-4 bg-slate-200 px-4 py-2 rounded w-full font-bold text-slate-600">Understood</button></div></div></div>

    <!-- JS Logic -->
    <script>
        let currentMode = 'standard'; 

        window.addEventListener('load', () => {
            document.getElementById('reportDate').valueAsDate = new Date();
            updateBaseCurrencyLabel();
            initSlides();
            setMealMode('standard', false); 
        });

        // TOAST LOGIC
        function showToast(mode) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMessage');
            msg.innerText = mode === 'safe' ? "Showing results with Floor Rule Protection" : "Showing Raw Values (No Protection)";
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function setMealMode(mode, loadDummy = true) {
            currentMode = mode;
            if(!loadDummy) {
                 document.getElementById('partInput').value = ""; 
                 document.getElementById('resultSection').classList.add('hidden');
                 document.getElementById('partInput').placeholder = mode === 'standard' ? 
                    "Copy the format without header:\nAhmad\tParis\t5\t5\t2\t4" : 
                    "Copy the format without header:\nAhmad\tParis\t5\t5\t5\t2\t0\t4";
            }
            const btnStd = document.getElementById('btnStandard');
            const btnGran = document.getElementById('btnGranular');
            const inputStd = document.getElementById('standardMealInput');
            const inputGran = document.getElementById('granularMealInputs');
            const headerStd = document.getElementById('excelHeaderStandard');
            const headerGran = document.getElementById('excelHeaderGranular');
            const instruction = document.getElementById('inputInstruction');

            if (mode === 'standard') {
                btnStd.className = "px-3 py-1 text-[10px] font-bold rounded bg-blue-100 text-blue-700 transition-all shadow-sm ring-1 ring-blue-200";
                btnGran.className = "px-3 py-1 text-[10px] font-bold rounded text-slate-500 hover:text-slate-700 transition-all hover:bg-slate-100";
                inputStd.classList.remove('hidden');
                inputGran.classList.add('hidden');
                headerStd.classList.remove('hidden');
                headerGran.classList.add('hidden');
                instruction.innerText = "Mode: Standard (6 Cols) - See Help";
            } else {
                btnGran.className = "px-3 py-1 text-[10px] font-bold rounded bg-blue-100 text-blue-700 transition-all shadow-sm ring-1 ring-blue-200";
                btnStd.className = "px-3 py-1 text-[10px] font-bold rounded text-slate-500 hover:text-slate-700 transition-all hover:bg-slate-100";
                inputStd.classList.add('hidden');
                inputGran.classList.remove('hidden');
                headerStd.classList.add('hidden');
                headerGran.classList.remove('hidden');
                instruction.innerText = "Mode: Granular (8 Cols) - See Help";
            }
            if(loadDummy) loadSampleParticipants();
        }
        
        function toggleCsvHelp() { document.getElementById('csvHelpModal').classList.toggle('hidden'); }
        function toggleFormatHelp() { document.getElementById('formatHelpModal').classList.toggle('hidden'); }
        function toggleEmailHelp() { document.getElementById('emailHelpModal').classList.toggle('hidden'); }
        function toggleMixedHelp() { document.getElementById('mixedHelpModal').classList.toggle('hidden'); }
        function toggleCurrencyHelp() { document.getElementById('currencyHelpModal').classList.toggle('hidden'); }

        let currentSlideIdx = 0; const totalSlides = 3; let slideInterval; let isPaused = false;
        function initSlides() { startSlideShow(); }
        function updateSlides() {
            for (let i=0; i<totalSlides; i++) { const el = document.getElementById(`slide-${i}`); if(el) el.className = i===currentSlideIdx ? "slide-content active-slide" : "slide-content hidden-slide"; }
            const bar = document.getElementById('progress-fill'); bar.classList.remove('progress-fill'); void bar.offsetWidth; bar.classList.add('progress-fill');
            bar.style.width = isPaused ? '0%' : '100%';
        }
        function nextSlide() { currentSlideIdx = (currentSlideIdx + 1) % totalSlides; updateSlides(); }
        function prevSlide() { currentSlideIdx = (currentSlideIdx - 1 + totalSlides) % totalSlides; updateSlides(); }
        function setSlide(n) { currentSlideIdx = n; updateSlides(); }
        function startSlideShow() { setTimeout(()=>{document.getElementById('progress-fill').style.width='100%'},50); slideInterval=setInterval(()=>{if(!isPaused)nextSlide()},3000); }
        document.getElementById('slider-container').addEventListener('mouseenter', ()=>{isPaused=true; document.getElementById('slider-container').classList.add('paused')});
        document.getElementById('slider-container').addEventListener('mouseleave', ()=>{isPaused=false; document.getElementById('slider-container').classList.remove('paused'); updateSlides()});

        function loadSampleRef() {
            const baseType = document.getElementById('baseCurrency').value;
            // FIXED: Only load if called
            let data = "";
            if (baseType === 'USD') { data = `Paris\t400\t60\t70\nNew York\t450\t65\t90`; } 
            else { data = `Jakarta\t4500000\t55\t47\nBali\t3200000\t45\t47`; }
            document.getElementById('refInput').value = data;
        }

        function loadSampleParticipants() {
            const refText = document.getElementById('refInput').value.trim();
            if (refText === "") { loadSampleRef(); }
            
            // SMART SAMPLE: Detect Context from Current Reference Input (Not just dropdown)
            // If ref input contains "Jakarta", assume Local. If "Paris", assume USD.
            const isRefLocal = refText.includes("Jakarta") || refText.includes("Bali");
            const cities = isRefLocal ? ["Jakarta", "Bali"] : ["Paris", "New York"];
            
            let data = "";
            const names = ["Ahmad", "Sarah", "John", "Ratna", "Budi"];
            for(let i=0; i<5; i++) {
                const c = cities[i % cities.length];
                const d = 3 + (i%2);
                if(currentMode==='standard') data += `${names[i]}\t${c}\t${d}\t${i}\t${i%2}\t4\n`;
                else data += `${names[i]}\t${c}\t${d}\t${i}\t${d}\t1\t0\t4\n`;
            }
            document.getElementById('partInput').value = data;
        }

        function parseTSV(text) { return text.trim().split(/\r?\n/).map(line => line.split(/\t/)); }
        function parseDaysInput(val, total) { if(!val) return 0; if(!isNaN(val)) return parseFloat(val); return (val.toLowerCase().startsWith('y')) ? total : 0; }
        function parseLegs(val) { return (!val || isNaN(val)) ? 4 : parseFloat(val); }
        function formatCurrency(num, curr) { return new Intl.NumberFormat('en-US', {style:'currency', currency:curr}).format(num); }
        function updateBaseCurrencyLabel() { 
            const t = document.getElementById('currencyCode').value; 
            document.getElementById('baseCurrency').options[0].text = `Same as Target (${t})`; 
            updateRefHeaders(); 
        }
        function updateRefHeaders() {
            const t = document.getElementById('currencyCode').value;
            const b = document.getElementById('baseCurrency').value;
            document.getElementById('dsaRefHeader').innerText = b==='USD' ? 'DSA ($)' : `DSA (${t})`;
        }

        let calculatedData = [];
        let globalFloorRuleActive = true;

        function processData(useFloorRule = true) {
            showToast(useFloorRule ? 'safe' : 'raw');
            globalFloorRuleActive = useFloorRule;
            const unore = parseFloat(document.getElementById('unoreRate').value)||15400;
            const targetCurr = document.getElementById('currencyCode').value;
            const baseType = document.getElementById('baseCurrency').value;
            const incRate = parseFloat(document.getElementById('incidentalRate').value)||20;
            
            let mRate=0, bRate=0, lRate=0, dRate=0;
            if(currentMode==='standard') mRate = parseFloat(document.getElementById('mealDedRateStandard').value)||30;
            else { bRate=parseFloat(document.getElementById('bfDedRate').value)||6; lRate=parseFloat(document.getElementById('lunchDedRate').value)||12; dRate=parseFloat(document.getElementById('dinnerDedRate').value)||12; }

            const refMap = {};
            parseTSV(document.getElementById('refInput').value).forEach(l => { if(l.length>=2) refMap[l[0].trim().toLowerCase()] = {dsa:parseFloat(l[1])||0, roomPct:parseFloat(l[2])||50, tf:parseFloat(l[3])||47}; });

            const rows = parseTSV(document.getElementById('partInput').value);
            const tbody = document.getElementById('resultBody'); tbody.innerHTML='';
            calculatedData = [];
            let grandTotal = 0;

            document.getElementById('headerTotalLocal').innerText = `Total (${targetCurr})`;
            document.getElementById('baseDsaHeader').innerText = baseType==='USD' ? 'Base ($)' : `Base (${targetCurr})`;

            const badge = document.getElementById('modeBadge');
            if(useFloorRule) {
                badge.innerText = "Mode: With Floor Rule (Safe)";
                badge.className = "text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 border border-blue-200 font-bold shadow-sm";
            } else {
                badge.innerText = "Mode: Without Floor Rule (Raw)";
                badge.className = "text-xs px-2 py-1 rounded bg-slate-700 text-white border border-slate-800 font-bold shadow-sm";
            }

            rows.forEach(p => {
                if(p.length < 2) return;
                const name=p[0], city=p[1], days=parseFloat(p[2])||0, hDays=parseDaysInput(p[3], days);
                let mDays=0, bDays=0, lDays=0, dDays=0, legs=4;

                if(currentMode==='standard') { mDays = parseDaysInput(p[4], days); legs = parseLegs(p[5]); }
                else { bDays=parseDaysInput(p[4], days); lDays=parseDaysInput(p[5], days); dDays=parseDaysInput(p[6], days); legs=parseLegs(p[7]); }

                const ref = refMap[city.toLowerCase().trim()];
                if(!ref) { tbody.innerHTML += `<tr><td colspan="12" class="text-red-500 p-2 text-xs">Error: City '${city}' not found in Reference Data.</td></tr>`; return; }

                const base = ref.dsa, inc = base * incRate/100 * days;
                const hDed = base * ref.roomPct/100 * hDays;
                let mDed = currentMode==='standard' ? base * mRate/100 * mDays : (base*bRate/100*bDays)+(base*lRate/100*lDays)+(base*dRate/100*dDays);
                
                let net = (base * days) - (hDed + mDed);
                let floorHit = false;
                if(useFloorRule && net < inc) { net = inc; floorHit = true; }
                if(net < 0) net = 0;

                const tfUSD = ref.tf * legs;
                let final = 0, refUSD = 0;

                if(baseType === 'USD') {
                    refUSD = net + tfUSD;
                    final = (targetCurr==='USD') ? refUSD : refUSD * unore;
                } else {
                    const tfLocal = tfUSD * unore;
                    final = net + tfLocal;
                    refUSD = (net / unore) + tfUSD;
                }
                
                grandTotal += final;
                calculatedData.push({name, city, days, base, inc, hDays, mDays, bDays, lDays, dDays, legs, deductions:hDed+mDed, net, tfUSD, final, baseType, refTotalUSD: refUSD, roomPct: ref.roomPct, mealPct: (currentMode==='standard'?mRate:0), bfPct: bRate, lPct: lRate, dPct: dRate});

                let sym = baseType==='USD' ? '$' : '';
                let mealTxt = currentMode==='standard' ? `<span class="bg-orange-100 px-1 rounded text-orange-800">${mDays}</span>` : `<span class="text-[9px]">B${bDays} L${lDays} D${dDays}</span>`;

                tbody.innerHTML += `<tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="px-4 py-2">${name}</td><td class="px-4 py-2">${city}</td><td class="text-center">${days}</td><td class="text-center">${sym}${base.toLocaleString()}</td><td class="text-center text-purple-600">${sym}${inc.toLocaleString()}</td>
                    <td class="text-center"><span class="bg-blue-100 px-1 rounded text-blue-800">${hDays}</span></td>
                    <td class="text-center">${mealTxt}</td>
                    <td class="text-right text-red-500">-${sym}${(hDed+mDed).toLocaleString()}</td><td class="text-right font-bold text-blue-700">${sym}${net.toLocaleString()}${floorHit?' á´¾':''}</td>
                    <td class="text-right">$${tfUSD}</td><td class="text-right text-slate-400 text-xs">$${refUSD.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
                    <td class="pl-6 pr-8 text-right font-bold text-emerald-700">${formatCurrency(final, targetCurr)}</td></tr>`;
            });
            document.getElementById('grandTotalDisplay').innerText = formatCurrency(grandTotal, targetCurr);
            document.getElementById('resultSection').classList.remove('hidden');
        }

        function exportToExcelWithFormulas() {
            if (calculatedData.length === 0) { alert("Calculate first!"); return; }
            const unore = parseFloat(document.getElementById('unoreRate').value)||15400;
            const curr = document.getElementById('currencyCode').value;
            const baseType = document.getElementById('baseCurrency').value;
            const incPct = parseFloat(document.getElementById('incidentalRate').value)||20;
            const reportDate = document.getElementById('reportDate').value;
            const missionName = document.getElementById('missionName').value || "UN Travel Audit";
            const timestamp = new Date().toLocaleString();
            
            let head = "", rows = "";
            const totalCols = currentMode === 'standard' ? 13 : 15;
            
            if (currentMode === 'standard') {
                head = `<th>Name</th><th>City</th><th>Days</th><th>Base</th><th>Hotel Days</th><th>Meal Days</th><th>Legs</th><th>Incidental</th><th>Deductions</th><th>Net Payable</th><th>TF ($)</th><th>Total USD (Ref)</th><th>Total ${curr}</th>`;
                calculatedData.forEach((r, i) => {
                    const ri = i + 5; 
                    const fInc = `=(D${ri}*${incPct/100})*C${ri}`;
                    const fDed = `=((D${ri}*${r.roomPct/100})*E${ri})+((D${ri}*${r.mealPct/100})*F${ri})`;
                    const floor = globalFloorRuleActive ? `MAX(H${ri}, (D${ri}*C${ri})-I${ri})` : `MAX(0, (D${ri}*C${ri})-I${ri})`;
                    
                    let fRefUSD="", fFinal="";
                    if(baseType === 'USD') { fFinal = `=(J${ri}+K${ri})*${unore}`; fRefUSD = `=(J${ri}+K${ri})`; }
                    else { fFinal = `=J${ri}+(K${ri}*${unore})`; fRefUSD = `=(J${ri}/${unore})+K${ri}`; } 
                    
                    rows += `<tr><td>${r.name}</td><td>${r.city}</td><td x:num>${r.days}</td><td x:num>${r.base}</td><td x:num>${r.hDays}</td><td x:num>${r.mDays}</td><td x:num>${r.legs}</td><td x:num x:fmla="${fInc}">${r.inc.toFixed(2)}</td><td x:num x:fmla="${fDed}">${r.deductions.toFixed(2)}</td><td x:num x:fmla="${floor}">${r.net.toFixed(2)}</td><td x:num>${r.tfUSD}</td><td x:num x:fmla="${fRefUSD}">${r.refTotalUSD.toFixed(2)}</td><td x:num x:fmla="${fFinal}">${r.final.toFixed(0)}</td></tr>`;
                });
            } else {
                head = `<th>Name</th><th>City</th><th>Days</th><th>Base</th><th>Hotel Days</th><th>B</th><th>L</th><th>D</th><th>Legs</th><th>Incidental</th><th>Deductions</th><th>Net Payable</th><th>TF ($)</th><th>Total USD (Ref)</th><th>Total ${curr}</th>`;
                calculatedData.forEach((r, i) => {
                    const ri = i + 5; 
                    const fInc = `=(D${ri}*${incPct/100})*C${ri}`;
                    const fDed = `=((D${ri}*${r.roomPct/100})*E${ri}) + ((D${ri}*${r.bfPct/100})*F${ri}) + ((D${ri}*${r.lPct/100})*G${ri}) + ((D${ri}*${r.dPct/100})*H${ri})`;
                    const floor = globalFloorRuleActive ? `MAX(J${ri}, (D${ri}*C${ri})-K${ri})` : `MAX(0, (D${ri}*C${ri})-K${ri})`;
                    
                    let fRefUSD="", fFinal="";
                    if(baseType === 'USD') { fFinal = `=(L${ri}+M${ri})*${unore}`; fRefUSD = `=(L${ri}+M${ri})`; }
                    else { fFinal = `=L${ri}+(M${ri}*${unore})`; fRefUSD = `=(L${ri}/${unore})+M${ri}`; } 

                    rows += `<tr><td>${r.name}</td><td>${r.city}</td><td x:num>${r.days}</td><td x:num>${r.base}</td><td x:num>${r.hDays}</td><td x:num>${r.bDays}</td><td x:num>${r.lDays}</td><td x:num>${r.dDays}</td><td x:num>${r.legs}</td><td x:num x:fmla="${fInc}">${r.inc.toFixed(2)}</td><td x:num x:fmla="${fDed}">${r.deductions.toFixed(2)}</td><td x:num x:fmla="${floor}">${r.net.toFixed(2)}</td><td x:num>${r.tfUSD}</td><td x:num x:fmla="${fRefUSD}">${r.refTotalUSD.toFixed(2)}</td><td x:num x:fmla="${fFinal}">${r.final.toFixed(0)}</td></tr>`;
                });
            }

            let table = `<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><style>th{font-weight:bold;background:#f3f4f6;border:1px solid #ddd}td{border:1px solid #ddd}</style></head><body><table>
            <tr><td colspan="${totalCols}"><b>${missionName}</b></td></tr>
            <tr><td colspan="${totalCols}">Generated by UN Auto-Calculation Engine at ${timestamp}</td></tr>
            <tr><td colspan="${totalCols}">Date: ${reportDate} | UNORE: ${unore} | Target: ${curr} | Base: ${baseType}</td></tr>
            <tr>${head}</tr>
            ${rows}</table></body></html>`;
            const blob = new Blob([table], { type: 'application/vnd.ms-excel' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `UN_Audit.xls`; document.body.appendChild(link); link.click();
        }
    </script>
</body>
</html>
